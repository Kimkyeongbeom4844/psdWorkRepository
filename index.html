<!DOCTYPE html>
<html lang="kr">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>웹툰PSD샘플</title>
  </head>
  <body>
    <div class="wrap">
      <div>웹툰번역</div>
      <input type="file" name="업로드" id="" accept=".psd" />
      <button class="saveImg">저장</button>
      <div class="showImg"></div>
      <a class="hiddenCapture"></a>
    </div>
    <div class="showPsd" style="position: absolute">
      <!-- <div
        class="hideDiv"
        style="
          position: absolute;
          top: 0;
          bottom: 0;
          right: 0;
          left: 0;
          z-index: 10;
          background-color: white;
        "
      ></div> -->
    </div>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script type="module">
      import Psd from "./node_modules/@webtoon/psd/dist/index.js";

      const inputEl = document.querySelector("input[type=file]");
      const showPsd = document.querySelector(".showPsd");
      const showImg = document.querySelector(".showImg");
      inputEl.addEventListener("change", async () => {
        const file = inputEl.files[0];
        const result = await file.arrayBuffer();
        const psdFile = Psd.parse(result);

        const compositeBuffer = await psdFile.composite();
        // console.log(compositeBuffer);
        // console.log(psdFile);
        function gcd(a, b) {
          let r;
          while (b != 0) {
            r = a % b;
            a = b;
            b = r;
          }
          return a;
        }
        const ratio = {
          x: psdFile.width / gcd(psdFile.width, psdFile.height),
          y: psdFile.height / gcd(psdFile.width, psdFile.height),
        };
        // const canvasElement = document.createElement("canvas");
        // const context = canvasElement.getContext("2d");
        // const compositeBuffer = await psdFile.composite();
        // const imageDatas = new ImageData(
        //   compositeBuffer,
        //   psdFile.width,
        //   psdFile.height
        // );
        // context.putImageData(imageDatas, 0, 0);
        // canvasElement.width = psdFile.width;
        // canvasElement.height = psdFile.height;

        // showPsd.append(canvasElement);
        console.log(psdFile.width, psdFile.height, ratio.x, ratio.y);
        let arr = [];
        for (const layer of psdFile.layers) {
          const pixelData = await layer.composite();
          console.log(layer);
          // console.log(
          //   `이름 : ${layer.layerFrame.layerProperties.name}, 가로 : ${layer.layerFrame.width}, 세로 : ${layer.layerFrame.height}, top : ${layer.layerFrame.layerProperties.top}, left : ${layer.layerFrame.layerProperties.left}`
          // );
          // console.log(pixelData);
          const canvasElement = document.createElement("canvas");
          const context = canvasElement.getContext("2d");
          const imageDatas = new ImageData(
            pixelData,
            layer.layerFrame.width,
            layer.layerFrame.height
          );
          canvasElement.width = layer.layerFrame.width;
          canvasElement.height = layer.layerFrame.height;
          context.putImageData(imageDatas, 0, 0);
          const layerInfo = document.createElement("h4");
          layerInfo.innerText = `이름 : ${layer.layerFrame.layerProperties.name}, 가로 : ${layer.layerFrame.width}, 세로 : ${layer.layerFrame.height}, top : ${layer.layerFrame.layerProperties.top}, left : ${layer.layerFrame.layerProperties.left}`;
          showPsd.append(layerInfo);
          showPsd.append(canvasElement);
          showPsd.append(document.createElement("br"));
          arr.push(layer.layerFrame.layerProperties.name);
        }
        console.log(
          arr.length,
          arr.length === document.getElementsByTagName("canvas").length
        );
        for (let i = 0; i < arr.length; i++) {
          await html2canvas(document.getElementsByTagName("canvas")[i]).then(
            function (canvas) {
              const hiddenCapture = document.querySelector(".hiddenCapture");
              hiddenCapture.href = canvas.toDataURL();
              hiddenCapture.download = `${arr[i]}.jpg`;
              hiddenCapture.click();
            }
          );
        }
        // for (let i = 30; i < arr.length; i++) {
        //   html2canvas(document.getElementsByTagName("canvas")[i]).then(
        //     function (canvas) {
        //       const hiddenCapture = document.querySelector(".hiddenCapture");
        //       hiddenCapture.href = canvas.toDataURL("image/jpeg");
        //       hiddenCapture.download = `${arr[i]}`;
        //       hiddenCapture.click();
        //     }
        //   );
        // }

        // html2canvas(document.getElementsByTagName("canvas")[0]).then(function (
        //   canvas
        // ) {
        //   const hiddenCapture = document.querySelector(".hiddenCapture");
        //   hiddenCapture.href = canvas.toDataURL("image/jpg");
        //   hiddenCapture.download = `${arr[0]}`;
        //   hiddenCapture.click();
        // });
        // html2canvas(document.getElementsByTagName("canvas")[1]).then(function (
        //   canvas
        // ) {
        //   const hiddenCapture = document.querySelector(".hiddenCapture");
        //   hiddenCapture.href = canvas.toDataURL("image/jpeg");
        //   hiddenCapture.download = `${arr[1]}`;
        //   hiddenCapture.click();
        // });
        // html2canvas(document.getElementsByTagName("canvas")[3]).then(function (
        //   canvas
        // ) {
        //   const hiddenCapture = document.querySelector(".hiddenCapture");
        //   hiddenCapture.href = canvas.toDataURL("image/jpeg");
        //   hiddenCapture.download = `${arr[3]}`;
        //   hiddenCapture.click();
        // });
        // html2canvas(document.getElementsByTagName("canvas")[9]).then(function (
        //   canvas
        // ) {
        //   const hiddenCapture = document.querySelector(".hiddenCapture");
        //   hiddenCapture.href = canvas.toDataURL("image/jpeg");
        //   hiddenCapture.download = `${arr[9]}`;
        //   hiddenCapture.click();
        // });
        // html2canvas(document.getElementsByTagName("canvas")[20]).then(function (
        //   canvas
        // ) {
        //   const hiddenCapture = document.querySelector(".hiddenCapture");
        //   hiddenCapture.href = canvas.toDataURL("image/jpeg");
        //   hiddenCapture.download = `${arr[20]}`;
        //   hiddenCapture.click();
        // });

        // html2canvas(showPsd.children[1]).then(function (canvas) {
        //   showPsd.removeChild(showPsd.children[1]);
        //   // const hiddenCapture = document.querySelector(".hiddenCapture");
        //   // hiddenCapture.href = canvas.toDataURL("image/jpeg");
        //   // hiddenCapture.download = `(수정)${file.name.split(".psd")[0]}`;
        //   // hiddenCapture.click();
        //   showImg.innerHTML = `<img src=${canvas.toDataURL(
        //     "image/jpeg"
        //   )} width=${ratio.x * 30} height=${ratio.y * 30} >`;
        //   inputEl.value = "";
        //   showPsd.innerHTML += "";
        //   return canvas.toDataURL("image/jpeg");
        // });
      });

      // const saveImg = document.querySelector(".saveImg");
      // saveImg.addEventListener("click", function () {
      //   console.log(showPsd.children[0]);
      //   html2canvas(showPsd.children[0]).then(function (canvas) {
      //     // console.log(canvas.toDataURL("image/jpeg"));
      //     const hiddenCapture = document.querySelector(".hiddenCapture");
      //     hiddenCapture.href = canvas.toDataURL("image/jpeg");
      //     hiddenCapture.download = `(수정)`;
      //     hiddenCapture.click();
      //     return canvas.toDataURL("image/jpeg");
      //   });
      // });
    </script>
  </body>
</html>
